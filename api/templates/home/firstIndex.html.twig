{% extends 'base.html.twig' %}

{% block title %}Hello HomeController!{% endblock %}

{% block body %}
<style>
    .example-wrapper { margin: 1em auto; max-width: 800px; width: 95%; font: 18px/1.5 sans-serif; }
    .example-wrapper code { background: #F5F5F5; padding: 2px 6px; }
</style>

<div class="example-wrapper">
    <h1>Hello {{ controller_name }}! ✅</h1>
    <div id="demo-div"></div>
    <div class="form-outline">
        <input type="text" id="demo-input" class="form-control" onKeyUp="cleRelachee(event)" />
        <label class="form-label" for="demo-input">Barre de recherche</label>
    </div>
</div>
    
<script>
    async function cleRelachee(evt){         
        const response = await fetch(`https://localhost/greetings?page=1&name=${evt.target.value}`);
        const jsonData = await response.json();
        console.log(jsonData); 
        if (jsonData["hydra:totalItems"]>0){
            console.log('Afficher les resultats dans le front')
            const element = document.getElementById('demo-div')
            viderContainer(element)
            jsonData["hydra:member"].forEach(function(item) {
                const innerElement = document.createElement('span')
                innerElement.setAttribute('class','text-success')
                innerElement.setAttribute('id',`item-${item.id}`)
                innerElement.append(item.name)
                element.append(innerElement) 
                element.append(document.createElement('br'))
            });

        }else {
            console.log('Aucun élément à afficher')
            const element = document.getElementById('demo-div')
            viderContainer(element)
            const innerElement = document.createElement('span')
            innerElement.setAttribute('class','text-danger')
            innerElement.append('Aucun élément à afficher')
            element.append(innerElement) 
        }
    }
        function viderContainer(myNode){
            while (myNode.firstChild) {
                myNode.removeChild(myNode.lastChild);
            }
        }
    const evtSource = new EventSource("https://localhost/.well-known/mercure?topic=https://localhost/greetings/7");
    evtSource.onmessage = (event) => {
        console.log(JSON.parse(event.data));
        const span = document.getElementById('item-7')
        if (span) {
            span.innerText = JSON.parse(event.data).name;
        }

    };

</script>

{% endblock %}
